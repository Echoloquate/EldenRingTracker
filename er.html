<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elden Ring - Item Tracker</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');

  :root {
    --gold: #c8a84e;
    --gold-dim: #8a7235;
    --gold-bright: #e8cc6a;
    --bg: #0d0c0a;
    --bg-card: #16140f;
    --bg-card-hover: #1d1a13;
    --border: #2a2518;
    --border-light: #3d3525;
    --text: #c4b99a;
    --text-dim: #7a7060;
    --text-bright: #e8dcc4;
    --checked-text: #4a4438;
    --green: #5a8a4a;
    --green-dim: #3a5a2a;
    --red: #8a3a3a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lora', Georgia, serif;
    font-size: 17px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* Subtle texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-conic-gradient(rgba(200,168,78,0.008) 0% 25%, transparent 0% 50%) 0 0 / 4px 4px;
    pointer-events: none;
    z-index: 999;
  }

  header {
    text-align: center;
    padding: 3rem 1rem 1rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(200,168,78,0.06) 0%, transparent 100%);
  }

  header h1 {
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: clamp(1.6rem, 4vw, 2.4rem);
    color: var(--gold);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    text-shadow: 0 0 40px rgba(200,168,78,0.15);
  }

  header h1 span {
    display: block;
    font-size: 0.45em;
    color: var(--text-dim);
    letter-spacing: 0.3em;
    margin-top: 0.3rem;
    font-weight: 400;
  }

  /* Progress bar area */
  .progress-area {
    max-width: 900px;
    margin: 0 auto;
    padding: 1.2rem 1.5rem;
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
  }

  .progress-stats {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.5rem;
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .progress-stats .count { color: var(--gold); }
  .progress-stats .percent { color: var(--text-dim); }

  .progress-bar {
    width: 100%;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--gold-dim), var(--gold));
    border-radius: 2px;
    transition: width 0.4s ease;
    box-shadow: 0 0 8px rgba(200,168,78,0.3);
  }

  /* Controls */
  .controls {
    max-width: 900px;
    margin: 0 auto;
    padding: 0.8rem 1.5rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .controls input[type="search"] {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem 0.8rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-bright);
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .controls input[type="search"]:focus {
    border-color: var(--gold-dim);
  }

  .controls input[type="search"]::placeholder {
    color: var(--text-dim);
  }

  .filter-btn {
    padding: 0.45rem 0.9rem;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-btn:hover { border-color: var(--gold-dim); color: var(--text); }
  .filter-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(200,168,78,0.08); }

  /* Main content */
  main {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 1.5rem 4rem;
  }

  /* DLC divider */
  .dlc-divider {
    text-align: center;
    padding: 2.5rem 0 0.5rem;
  }

  .dlc-divider h2 {
    font-family: 'Cinzel', serif;
    font-weight: 600;
    font-size: 1rem;
    color: var(--gold-dim);
    letter-spacing: 0.25em;
    text-transform: uppercase;
    position: relative;
    display: inline-block;
  }

  .dlc-divider h2::before,
  .dlc-divider h2::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 60px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold-dim));
  }

  .dlc-divider h2::before { right: calc(100% + 16px); }
  .dlc-divider h2::after { left: calc(100% + 16px); transform: scaleX(-1); }

  /* Location sections */
  .location {
    margin-top: 1.5rem;
  }

  .location-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    transition: border-color 0.2s;
  }

  .location-header:hover { border-bottom-color: var(--gold-dim); }

  .location-header h3 {
    font-family: 'Cinzel', serif;
    font-weight: 600;
    font-size: 1.05rem;
    color: var(--text-bright);
    letter-spacing: 0.06em;
  }

  .location-count {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    color: var(--text-dim);
    letter-spacing: 0.05em;
  }

  .location-count .done { color: var(--green); }

  .location.all-done .location-header h3 { color: var(--gold-dim); }
  .location.all-done .location-count .done { color: var(--gold-dim); }

  /* Item list */
  .items { padding: 0.3rem 0; }

  .item {
    display: flex;
    align-items: flex-start;
    gap: 0.7rem;
    padding: 0.5rem 0.6rem;
    border-radius: 4px;
    transition: background 0.15s;
    cursor: pointer;
  }

  .item:hover { background: var(--bg-card-hover); }

  .item input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    min-width: 18px;
    border: 1.5px solid var(--border-light);
    border-radius: 3px;
    margin-top: 3px;
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
    background: transparent;
  }

  .item input[type="checkbox"]:hover {
    border-color: var(--gold-dim);
  }

  .item input[type="checkbox"]:checked {
    background: var(--gold-dim);
    border-color: var(--gold-dim);
  }

  .item input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    color: var(--bg);
    font-weight: bold;
  }

  .item-text {
    flex: 1;
    transition: color 0.2s;
  }

  .item.checked .item-text {
    color: var(--checked-text);
    text-decoration: line-through;
    text-decoration-color: var(--border);
  }

  .item-replaces {
    display: inline;
    font-weight: 600;
    color: var(--gold);
    transition: color 0.2s;
  }

  .item.checked .item-replaces {
    color: var(--checked-text);
  }

  /* Collapse animation */
  .items[data-collapsed="true"] {
    display: none;
  }

  /* Hidden by filter */
  .item[data-hidden="true"] { display: none; }
  .location[data-hidden="true"] { display: none; }
  .dlc-divider[data-hidden="true"] { display: none; }

  /* Reset button */
  .reset-area {
    text-align: center;
    padding: 3rem 0;
    border-top: 1px solid var(--border);
    margin-top: 3rem;
  }

  .reset-btn {
    padding: 0.5rem 1.5rem;
    background: transparent;
    border: 1px solid var(--red);
    border-radius: 4px;
    color: var(--red);
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .reset-btn:hover {
    background: rgba(138,58,58,0.15);
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

  /* Room picker modal */
  .room-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .room-overlay[hidden] { display: none; }

  .room-modal {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 2.5rem 2rem;
    max-width: 380px;
    width: 90%;
    text-align: center;
  }

  .room-modal h2 {
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    color: var(--gold);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 0.4rem;
  }

  .room-modal p {
    color: var(--text-dim);
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
  }

  .room-modal input[type="text"] {
    width: 100%;
    padding: 0.6rem 0.8rem;
    background: var(--bg);
    border: 1px solid var(--border-light);
    border-radius: 4px;
    color: var(--gold-bright);
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    letter-spacing: 0.25em;
    text-align: center;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s;
  }

  .room-modal input[type="text"]:focus {
    border-color: var(--gold-dim);
  }

  .room-modal input[type="text"]::placeholder {
    color: var(--text-dim);
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: none;
  }

  .room-modal .room-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .room-modal .room-btn {
    flex: 1;
    padding: 0.55rem 0.8rem;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    background: transparent;
    color: var(--text);
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .room-modal .room-btn:hover {
    border-color: var(--gold-dim);
    color: var(--gold);
  }

  .room-modal .room-btn.primary {
    border-color: var(--gold-dim);
    color: var(--gold);
    background: rgba(200,168,78,0.08);
  }

  .room-modal .room-btn.primary:hover {
    background: rgba(200,168,78,0.15);
  }

  .room-modal .room-error {
    color: var(--red);
    font-size: 0.85rem;
    margin-top: 0.7rem;
    min-height: 1.2em;
  }

  /* Room badge in controls bar */
  .room-badge {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gold-dim);
  }

  .room-badge code {
    color: var(--gold);
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
  }

  .room-badge .leave-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    cursor: pointer;
    padding: 0.1rem 0.3rem;
    margin-left: 0.2rem;
    transition: color 0.2s;
  }

  .room-badge .leave-btn:hover {
    color: var(--red);
  }

  .sync-error {
    max-width: 900px;
    margin: 0 auto;
    padding: 0.6rem 1.5rem;
    background: rgba(138,58,58,0.15);
    border-bottom: 1px solid var(--red);
    color: var(--red);
    font-size: 0.9rem;
    text-align: center;
  }

  .sync-error[hidden] { display: none; }

  .nav-link {
    display: inline-block;
    margin-top: 0.8rem;
    padding: 0.4rem 1rem;
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--gold-dim);
    text-decoration: none;
    border: 1px solid var(--border-light);
    border-radius: 4px;
    transition: all 0.2s;
  }

  .nav-link:hover { color: var(--gold); border-color: var(--gold-dim); background: rgba(200,168,78,0.08); }

  /* Info box */
  .info-box {
    max-width: 900px;
    margin: 0 auto;
    border-bottom: 1px solid var(--border);
  }

  .info-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    width: 100%;
    padding: 0.5rem 1.5rem;
    background: transparent;
    border: none;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: color 0.2s;
  }

  .info-toggle:hover { color: var(--gold-dim); }

  .info-toggle .arrow {
    display: inline-block;
    transition: transform 0.2s;
    font-size: 0.5rem;
  }

  .info-toggle.open .arrow { transform: rotate(180deg); }

  .info-content {
    display: none;
    padding: 0 1.5rem 1rem;
    color: var(--text-dim);
    font-size: 0.92rem;
    line-height: 1.7;
  }

  .info-content.open { display: block; }

  .info-content p { margin-bottom: 0.6rem; }

  .info-content a {
    color: var(--gold-dim);
    text-decoration: none;
    transition: color 0.2s;
  }

  .info-content a:hover { color: var(--gold); }

  /* Loading spinner */
  .loading {
    display: flex;
    justify-content: center;
    padding: 4rem 0;
  }

  .loading .spinner {
    width: 28px;
    height: 28px;
    border: 2.5px solid var(--border-light);
    border-top-color: var(--gold-dim);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Category toggles */
  .category-toggles {
    max-width: 900px;
    margin: 0 auto;
    padding: 0.6rem 1.5rem;
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .category-toggles .cat-label {
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-right: 0.2rem;
  }

  .cat-btn {
    padding: 0.4rem 0.7rem;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .cat-btn:hover { border-color: var(--gold-dim); color: var(--text); }
  .cat-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(200,168,78,0.08); }

  .toggle-sep {
    width: 1px;
    height: 1.2rem;
    background: var(--border-light);
    margin: 0 0.3rem;
  }

  @media (max-width: 600px) {
    .controls { padding: 0.6rem 1rem; }
    .category-toggles { padding: 0.6rem 1rem; }
    main { padding: 0 1rem 3rem; }
    .progress-area { padding: 0.8rem 1rem; }
  }
</style>
<!-- Firebase SDK (compat builds for simplicity - no bundler needed) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="er-data.js"></script>
</head>
<body>

<header>
  <h1>Elden Ring<span>Item Tracker</span></h1>
  <a href="./" class="nav-link">&larr; All Trackers</a>
  <a href="ds3.html" class="nav-link">Dark Souls III &rarr;</a>
</header>

<div class="info-box">
  <button class="info-toggle" id="infoToggle">
    About this tracker <span class="arrow">&#9660;</span>
  </button>
  <div class="info-content" id="infoContent">
    <p>This is a checklist for the <a href="https://www.nexusmods.com/eldenring/mods/428" target="_blank" rel="noopener">Elden Ring Item and Enemy Randomizer</a> by thefifthmatt. It covers all key items, boss drops, golden seeds, sacred tears, and shop checks across the base game and Shadow of the Erdtree.</p>
    <p>Create a room to share progress with your co-op group in real time - just give everyone the same room code and checks will sync automatically.</p>
  </div>
</div>

<div class="category-toggles" id="categoryToggles">
  <span class="cat-label">Categories</span>
</div>

<div class="progress-area">
  <div class="progress-stats">
    <span class="count" id="progressCount">0 / 0</span>
    <span class="percent" id="progressPercent">0%</span>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
  </div>
</div>

<div class="controls">
  <input type="search" id="searchBox" placeholder="Search items or locations…">
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="unchecked">Remaining</button>
  <button class="filter-btn" data-filter="checked">Completed</button>
  <span class="room-badge" id="roomBadge" hidden>
    Room <code id="roomCodeDisplay"></code>
    <button class="leave-btn" id="leaveRoomBtn">Leave</button>
  </span>
</div>
<div class="sync-error" id="syncError" hidden></div>

<div class="room-overlay" id="roomOverlay">
  <div class="room-modal">
    <h2>Multiplayer Tracker</h2>
    <p>Create or join a room to sync progress with your group.</p>
    <input type="text" id="roomCodeInput" placeholder="Enter room code" maxlength="6" spellcheck="false" autocomplete="off">
    <div class="room-actions">
      <button class="room-btn primary" id="createRoomBtn">Create Room</button>
      <button class="room-btn" id="joinRoomBtn">Join Room</button>
    </div>
    <div class="room-error" id="roomError"></div>
  </div>
</div>

<main id="main"><div class="loading"><div class="spinner"></div></div></main>

<script>
// =============================================================================
// FIREBASE CONFIGURATION
// =============================================================================
const firebaseConfig = {
  apiKey: "AIzaSyAEWn2CFxUsowJDYrfog0HZeYCpzz2RKQA",
  authDomain: "elden-ring-tracker-de9af.firebaseapp.com",
  databaseURL: "https://elden-ring-tracker-de9af-default-rtdb.firebaseio.com",
  projectId: "elden-ring-tracker-de9af",
  storageBucket: "elden-ring-tracker-de9af.firebasestorage.app",
  messagingSenderId: "1049629299505",
  appId: "1:1049629299505:web:ef3ee3865bc3d2375e5610"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------------------------------------------------------------------
// Room & state management
// ---------------------------------------------------------------------------
const ROOM_KEY = 'elden-ring-tracker-room';
const CAT_KEY = 'elden-ring-tracker-categories';
const SEC_KEY = 'elden-ring-tracker-sections';

function itemId(locName, idx) {
  return `${locName.replace(/\./g, '%2E')}::${idx}`;
}

let checkedState = {};
let currentFilter = 'all';
let currentRoom = null;
let itemsRef = null;
let firebaseListener = null;
let categoriesRef = null;
let categoriesListener = null;
let waitingForInitialData = false;

// Category toggle state - default: all on except "Other Bosses"
const DEFAULT_CATEGORIES = CATEGORIES.map(c => c.id).filter(id => id !== 'boss');
let enabledCategories = new Set(DEFAULT_CATEGORIES);

// Section toggle state — 'base' and/or 'dlc'
let enabledSections = new Set(['base', 'dlc']);

// Load saved state from localStorage
(function loadSavedState() {
  const savedCat = localStorage.getItem(CAT_KEY);
  if (savedCat) {
    try {
      const arr = JSON.parse(savedCat);
      if (Array.isArray(arr)) enabledCategories = new Set(arr);
    } catch (e) {}
  }
  const savedSec = localStorage.getItem(SEC_KEY);
  if (savedSec) {
    try {
      const arr = JSON.parse(savedSec);
      if (Array.isArray(arr)) enabledSections = new Set(arr);
    } catch (e) {}
  }
})();

function saveCategoryState() {
  localStorage.setItem(CAT_KEY, JSON.stringify([...enabledCategories]));
}

function saveSectionState() {
  localStorage.setItem(SEC_KEY, JSON.stringify([...enabledSections]));
}

function syncCategoriesToFirebase() {
  if (categoriesRef) categoriesRef.set([...enabledCategories]);
}

function updateCategoryButtons() {
  document.querySelectorAll('.cat-btn').forEach(btn => {
    if (enabledCategories.has(btn.dataset.cat)) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}

function updateSectionButtons() {
  document.querySelectorAll('.sec-btn').forEach(btn => {
    if (enabledSections.has(btn.dataset.sec)) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

// ---------------------------------------------------------------------------
// Firebase sync
// ---------------------------------------------------------------------------
function joinRoom(code) {
  if (firebaseListener && itemsRef) {
    itemsRef.off('value', firebaseListener);
  }
  if (categoriesListener && categoriesRef) {
    categoriesRef.off('value', categoriesListener);
  }

  currentRoom = code.toUpperCase();
  localStorage.setItem(ROOM_KEY, currentRoom);
  itemsRef = db.ref('rooms/' + currentRoom + '/items');
  categoriesRef = db.ref('rooms/' + currentRoom + '/categories');

  firebaseListener = itemsRef.on('value', (snapshot) => {
    document.getElementById('syncError').hidden = true;
    checkedState = snapshot.val() || {};
    if (waitingForInitialData) {
      waitingForInitialData = false;
      render();
    } else {
      refreshUI();
    }
  }, (error) => {
    showSyncError('Firebase sync failed: ' + error.message + ' — check your database rules.');
    if (waitingForInitialData) {
      waitingForInitialData = false;
      render();
    }
  });

  // Sync category toggles with room
  categoriesListener = categoriesRef.on('value', (snapshot) => {
    const val = snapshot.val();
    if (val !== null) {
      const arr = Array.isArray(val) ? val : Object.values(val);
      enabledCategories = new Set(arr);
      saveCategoryState();
      updateCategoryButtons();
      applyFilters();
      updateProgress();
    } else {
      // New room - push current local categories
      categoriesRef.set([...enabledCategories]);
    }
  });

  document.getElementById('roomOverlay').hidden = true;
  document.getElementById('roomBadge').hidden = false;
  document.getElementById('roomCodeDisplay').textContent = currentRoom;
}

function leaveRoom() {
  if (firebaseListener && itemsRef) {
    itemsRef.off('value', firebaseListener);
  }
  if (categoriesListener && categoriesRef) {
    categoriesRef.off('value', categoriesListener);
  }
  firebaseListener = null;
  itemsRef = null;
  categoriesListener = null;
  categoriesRef = null;
  currentRoom = null;
  checkedState = {};
  localStorage.removeItem(ROOM_KEY);

  document.getElementById('roomBadge').hidden = true;
  document.getElementById('roomOverlay').hidden = false;
  document.getElementById('roomError').textContent = '';
  document.getElementById('roomCodeInput').value = '';

  refreshUI();
}

function showSyncError(msg) {
  const el = document.getElementById('syncError');
  el.textContent = msg;
  el.hidden = false;
}

function setItemChecked(id, checked) {
  if (checked) checkedState[id] = true;
  else delete checkedState[id];
  refreshUI();

  if (!itemsRef) return;
  const op = checked ? itemsRef.child(id).set(true) : itemsRef.child(id).remove();
  op.catch(() => showSyncError('Failed to sync - check Firebase database rules (must allow read/write).'));
}

function resetAllProgress() {
  if (!itemsRef) return;
  checkedState = {};
  refreshUI();
  itemsRef.remove()
    .catch(() => showSyncError('Failed to reset - check Firebase database rules.'));
}

// ---------------------------------------------------------------------------
// Progress — only counts items whose category and section are enabled
// ---------------------------------------------------------------------------
function sectionKey(s) { return s.section ? 'dlc' : 'base'; }

function getTotalAndChecked() {
  let total = 0, done = 0;
  DATA.forEach(s => {
    if (!enabledSections.has(sectionKey(s))) return;
    s.locations.forEach(loc => {
      loc.items.forEach((item, i) => {
        if (!enabledCategories.has(item.cat)) return;
        total++;
        if (checkedState[itemId(loc.name, i)]) done++;
      });
    });
  });
  return { total, done };
}

function updateProgress() {
  const { total, done } = getTotalAndChecked();
  document.getElementById('progressCount').textContent = `${done} / ${total}`;
  const pct = total ? Math.round((done / total) * 100) : 0;
  document.getElementById('progressPercent').textContent = `${pct}%`;
  document.getElementById('progressFill').style.width = `${pct}%`;
}

// ---------------------------------------------------------------------------
// Category toggles
// ---------------------------------------------------------------------------
function renderCategoryToggles() {
  const container = document.getElementById('categoryToggles');
  // Keep the label, clear dynamic elements
  container.querySelectorAll('.cat-btn, .sec-btn, .toggle-sep').forEach(b => b.remove());

  CATEGORIES.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'cat-btn' + (enabledCategories.has(cat.id) ? ' active' : '');
    btn.dataset.cat = cat.id;
    btn.textContent = cat.label;
    btn.addEventListener('click', () => {
      if (enabledCategories.has(cat.id)) {
        enabledCategories.delete(cat.id);
        btn.classList.remove('active');
      } else {
        enabledCategories.add(cat.id);
        btn.classList.add('active');
      }
      saveCategoryState();
      syncCategoriesToFirebase();
      applyFilters();
      updateProgress();
    });
    container.appendChild(btn);
  });

  // Separator + section toggles
  const sep = document.createElement('div');
  sep.className = 'toggle-sep';
  container.appendChild(sep);

  [{ id: 'base', label: 'Base Game' }, { id: 'dlc', label: 'DLC' }].forEach(sec => {
    const btn = document.createElement('button');
    btn.className = 'cat-btn sec-btn' + (enabledSections.has(sec.id) ? ' active' : '');
    btn.dataset.sec = sec.id;
    btn.textContent = sec.label;
    btn.addEventListener('click', () => {
      if (enabledSections.has(sec.id)) {
        enabledSections.delete(sec.id);
        btn.classList.remove('active');
      } else {
        enabledSections.add(sec.id);
        btn.classList.add('active');
      }
      saveSectionState();
      applyFilters();
      updateProgress();
    });
    container.appendChild(btn);
  });
}

// ---------------------------------------------------------------------------
// Rendering
// ---------------------------------------------------------------------------
function render() {
  const main = document.getElementById('main');
  main.innerHTML = '';

  DATA.forEach(section => {
    const secKey = section.section ? 'dlc' : 'base';

    if (section.section) {
      const divider = document.createElement('div');
      divider.className = 'dlc-divider';
      divider.dataset.section = secKey;
      divider.innerHTML = `<h2>${section.section}</h2>`;
      main.appendChild(divider);
    }

    section.locations.forEach(loc => {
      const locDiv = document.createElement('div');
      locDiv.className = 'location';
      locDiv.dataset.name = loc.name.toLowerCase();
      locDiv.dataset.section = secKey;

      const header = document.createElement('div');
      header.className = 'location-header';
      header.innerHTML = `
        <h3>${loc.name}</h3>
        <span class="location-count"><span class="done">0</span> / <span class="loc-total">${loc.items.length}</span></span>
      `;
      locDiv.appendChild(header);

      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'items';
      locDiv.appendChild(itemsDiv);

      header.addEventListener('click', () => {
        const collapsed = itemsDiv.dataset.collapsed === 'true';
        itemsDiv.dataset.collapsed = collapsed ? 'false' : 'true';
      });

      loc.items.forEach((item, i) => {
        const id = itemId(loc.name, i);
        const isChecked = !!checkedState[id];

        const itemDiv = document.createElement('div');
        itemDiv.className = 'item' + (isChecked ? ' checked' : '');
        itemDiv.dataset.id = id;
        itemDiv.dataset.cat = item.cat;

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = isChecked;

        const textSpan = document.createElement('span');
        textSpan.className = 'item-text';
        if (item.replaces) {
          textSpan.innerHTML = `${item.desc}. <span class="item-replaces">\u2192 ${item.replaces}</span>`;
        } else {
          textSpan.textContent = item.desc;
        }

        itemDiv.appendChild(cb);
        itemDiv.appendChild(textSpan);
        itemsDiv.appendChild(itemDiv);

        itemDiv.addEventListener('click', (e) => {
          if (e.target === cb) return;
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        });

        cb.addEventListener('change', () => {
          setItemChecked(id, cb.checked);
        });
      });

      main.appendChild(locDiv);
    });
  });

  // Reset button
  const resetArea = document.createElement('div');
  resetArea.className = 'reset-area';
  resetArea.innerHTML = `<button class="reset-btn" id="resetBtn">Reset All Progress</button>`;
  main.appendChild(resetArea);

  document.getElementById('resetBtn').addEventListener('click', () => {
    if (confirm('Reset all progress? This will clear progress for everyone in this room and cannot be undone.')) {
      resetAllProgress();
    }
  });

  applyFilters();
  updateProgress();
}

// Lightweight UI refresh - updates checkboxes, counts, and progress without rebuilding DOM
function refreshUI() {
  document.querySelectorAll('.location').forEach(locEl => {
    locEl.querySelectorAll('.item').forEach(itemEl => {
      const id = itemEl.dataset.id;
      const isChecked = !!checkedState[id];

      const cb = itemEl.querySelector('input[type="checkbox"]');
      if (cb.checked !== isChecked) cb.checked = isChecked;
      if (isChecked) itemEl.classList.add('checked');
      else itemEl.classList.remove('checked');
    });
  });

  updateProgress();
  applyFilters();
}

// ---------------------------------------------------------------------------
// Filters - now includes category check
// ---------------------------------------------------------------------------
function applyFilters() {
  const query = document.getElementById('searchBox').value.toLowerCase().trim();

  // Hide/show DLC divider based on section toggle
  document.querySelectorAll('.dlc-divider').forEach(d => {
    d.dataset.hidden = enabledSections.has(d.dataset.section) ? 'false' : 'true';
  });

  document.querySelectorAll('.location').forEach(locEl => {
    const locName = locEl.dataset.name;
    const sectionEnabled = enabledSections.has(locEl.dataset.section);
    let anyVisible = false;
    let locDone = 0;
    let locTotal = 0;

    locEl.querySelectorAll('.item').forEach(itemEl => {
      const id = itemEl.dataset.id;
      const cat = itemEl.dataset.cat;
      const isChecked = !!checkedState[id];
      const catEnabled = enabledCategories.has(cat);

      if (catEnabled) {
        locTotal++;
        if (isChecked) locDone++;
      }

      const text = itemEl.textContent.toLowerCase();
      const matchesSearch = !query || text.includes(query) || locName.includes(query);
      const matchesFilter = currentFilter === 'all' ||
        (currentFilter === 'checked' && isChecked) ||
        (currentFilter === 'unchecked' && !isChecked);

      const visible = sectionEnabled && catEnabled && matchesSearch && matchesFilter;
      itemEl.dataset.hidden = visible ? 'false' : 'true';
      if (visible) anyVisible = true;
    });

    // Update per-location counts (only enabled categories)
    const countEl = locEl.querySelector('.done');
    const totalEl = locEl.querySelector('.loc-total');
    if (countEl) countEl.textContent = locDone;
    if (totalEl) totalEl.textContent = locTotal;

    if (locTotal > 0 && locDone === locTotal) locEl.classList.add('all-done');
    else locEl.classList.remove('all-done');

    locEl.dataset.hidden = anyVisible ? 'false' : 'true';
  });
}

// Info box toggle
document.getElementById('infoToggle').addEventListener('click', () => {
  document.getElementById('infoToggle').classList.toggle('open');
  document.getElementById('infoContent').classList.toggle('open');
});

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    applyFilters();
  });
});

// Search
document.getElementById('searchBox').addEventListener('input', applyFilters);

// ---------------------------------------------------------------------------
// Room UI event handlers
// ---------------------------------------------------------------------------
document.getElementById('createRoomBtn').addEventListener('click', () => {
  const code = generateRoomCode();
  document.getElementById('roomError').textContent = '';
  joinRoom(code);
  render();
});

document.getElementById('joinRoomBtn').addEventListener('click', () => {
  const input = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  const errorEl = document.getElementById('roomError');
  if (!input || input.length < 3) {
    errorEl.textContent = 'Please enter a valid room code.';
    return;
  }
  errorEl.textContent = '';
  joinRoom(input);
  render();
});

document.getElementById('roomCodeInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('joinRoomBtn').click();
});

document.getElementById('leaveRoomBtn').addEventListener('click', () => {
  leaveRoom();
  render();
});

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
renderCategoryToggles();

const savedRoom = localStorage.getItem(ROOM_KEY);
if (savedRoom) {
  // Delay render until first Firebase snapshot — spinner stays visible
  waitingForInitialData = true;
  joinRoom(savedRoom);
} else {
  render();
  document.getElementById('roomOverlay').hidden = false;
}
</script>
</body>
</html>
